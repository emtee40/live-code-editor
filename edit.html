<!DOCTYPE html>
<title>Live HTML Editor</title>
<style>
  body {
    margin: 0;
  }
  .cm-editor {
    height: 100vh;
  }
</style>
<script type="module">
  import { html } from "@codemirror/lang-html";
  import { EditorState } from "@codemirror/state";
  import { EditorView, basicSetup } from "codemirror";
  function onChange() {
    const doc = editor.state.doc.toString();
    localStorage.setItem("code", doc);
    var previewFrame = top.preview;
    var document = previewFrame.document;
    document.open();
    document.write(doc);
    document.close();
  }
  var timeout = null;
  function debounceChanges() {
    if (timeout) {
      clearTimeout(timeout);
    }
    timeout = setTimeout(function callOnChange() {
      onChange();
    }, 300);
  }
  const editor = new EditorView({
    state: EditorState.create({
      doc:
        localStorage.getItem("code") ||
        "<!DOCTYPE html>\n" +
          "<p> Welcome to the real-time HTML editor. Type HTML in " +
          "the textarea above, and it will appear in a frame below.",
      extensions: [
        basicSetup,
        html(),
        EditorView.updateListener.of((update) => {
          if (update.docChanged) debounceChanges();
        }),
      ],
    }),
    parent: document.body,
  });
  onChange();
</script>
